import{r as l,j as e,e as Q}from"./index-CFxg3Tr1.js";import{R as Z,a as ee,b as te}from"./index-CqA6Po1E.js";import{g as S,a as ae}from"./session-BuNBObg0.js";import{N as se}from"./Navbar-C7K0pfzt.js";import"./components-JMU3ypcm.js";function re({isOpen:u,onClose:r,onApply:p,filterOptions:n,isLoading:i=!1}){const[c,d]=l.useState({place:[],type:[],origin:[]}),g=l.useRef(null),R=(s,x)=>{d(b=>{const A=b[s].some(v=>v.value===x.value);return{...b,[s]:A?b[s].filter(v=>v.value!==x.value):[...b[s],x]}})},F=()=>{p(c),d({place:[],type:[],origin:[]}),r()},O=()=>{d({place:[],type:[],origin:[]})};if(l.useEffect(()=>{const s=x=>{g.current&&!g.current.contains(x.target)&&r()};return u&&document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[u,r]),!u)return null;const j=c.place.length>0||c.type.length>0||c.origin.length>0,y=(s,x)=>c[s].some(b=>b.value===x);return e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex justify-center items-center p-4",children:e.jsxs("div",{ref:g,className:"bg-white rounded-xl p-4 w-full max-w-md max-h-[90vh] overflow-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-primary",children:"Filter"}),e.jsx("button",{onClick:r,className:"text-gray hover:text-primary text-xl",disabled:i,children:"Ã—"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm font-medium text-gray mb-2",children:["Place ",c.place.length>0&&`(${c.place.length})`]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:n.place.map(s=>e.jsx("button",{onClick:()=>R("place",s),disabled:i,className:`px-3 py-1 rounded-full text-sm border transition-colors ${y("place",s.value)?"bg-primary text-white border-primary":"bg-light text-primary border-primary-light hover:bg-primary-light"} ${i?"opacity-50 cursor-not-allowed":""}`,children:s.label},s.value))})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm font-medium text-gray mb-2",children:["Type ",c.type.length>0&&`(${c.type.length})`]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:n.type.map(s=>e.jsx("button",{onClick:()=>R("type",s),disabled:i,className:`px-3 py-1 rounded-full text-sm border transition-colors ${y("type",s.value)?"bg-primary text-white border-primary":"bg-light text-primary border-primary-light hover:bg-primary-light"} ${i?"opacity-50 cursor-not-allowed":""}`,children:s.label},s.value))})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-sm font-medium text-gray mb-2",children:["Origin ",c.origin.length>0&&`(${c.origin.length})`]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:n.origin.map(s=>e.jsx("button",{onClick:()=>R("origin",s),disabled:i,className:`px-3 py-1 rounded-full text-sm border transition-colors ${y("origin",s.value)?"bg-primary text-white border-primary":"bg-light text-primary border-primary-light hover:bg-primary-light"} ${i?"opacity-50 cursor-not-allowed":""}`,children:s.label},s.value))})]}),e.jsxs("div",{className:"flex justify-center items-center gap-4 mt-6",children:[e.jsx("button",{onClick:O,disabled:i||!j,className:`w-1/2 py-2 rounded-full font-medium transition-colors ${j&&!i?"text-primary hover:bg-primary-light":"text-gray cursor-not-allowed"}`,children:"Clear"}),e.jsx("button",{onClick:F,disabled:i||!j,className:`w-1/2 py-2 rounded-full font-medium transition-colors ${j&&!i?"bg-primary text-white hover:bg-primary/90":"bg-muted text-gray cursor-not-allowed"}`,children:i?"Applying...":"Apply"})]})]})})}const le=({onAllow:u,onClose:r,onRequestLocation:p})=>e.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-xl p-6 w-[90%] max-w-sm text-center",children:[e.jsx("h2",{className:"text-xl font-semibold text-primary mb-2",children:"Use Your Location?"}),e.jsx("p",{className:"text-gray mb-4 text-sm",children:"Allow access to your location to find nearby restaurants."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{u(),p()},className:"flex-1 bg-primary text-white rounded-lg py-2",children:"Allow"}),e.jsx("button",{onClick:r,className:"flex-1 bg-gray-200 text-gray-800 rounded-lg py-2",children:"Cancel"})]})]})}),ne=u=>{const r=new URLSearchParams;if(u.place.some(n=>n.value==="nearby")){const n=sessionStorage.getItem("makanmana_user_loc");if(n){const{latitude:i,longitude:c}=JSON.parse(n);r.append("nearby",`${i},${c}`)}}return u.place.filter(n=>n.value!=="nearby").forEach(n=>r.append("place",n.value)),u.type.forEach(n=>r.append("type",n.value)),u.origin.forEach(n=>r.append("origin",n.value)),`/filter?${r.toString()}`},oe=3,ie=60;function he(){const u=Q(),r=l.useRef(null),[p,n]=l.useState(!1),[i,c]=l.useState(null),[d,g]=l.useState([]),[R,F]=l.useState([]),[O,j]=l.useState({}),[y,s]=l.useState({place:[],type:[],origin:[]}),[x,b]=l.useState(""),[A,v]=l.useState(!1),[ce,I]=l.useState(!1),[D,M]=l.useState(!1),[k,P]=l.useState(!1),[q,C]=l.useState(!1),[G,_]=l.useState(!1),[T,$]=l.useState(null);l.useEffect(()=>{const t=sessionStorage.getItem("makanmana_user_loc");_(!!t)},[]);const B=t=>{const o=new Set,a=new Set,h=new Set;Array.isArray(t)?t.forEach(m=>{var N,E;"location"in m&&m.location&&o.add(m.location),(N=m.type)==null||N.forEach(w=>a.add(w)),(E=m.origin)==null||E.forEach(w=>h.add(w))}):Object.entries(t).forEach(([m,N])=>{o.add(m),N.forEach(E=>{var w,z;(w=E.type)==null||w.forEach(L=>a.add(L)),(z=E.origin)==null||z.forEach(L=>h.add(L))})});const f=m=>({label:m,value:m.toLowerCase()});return{place:Array.from(o).map(f),type:Array.from(a).map(f),origin:Array.from(h).map(f)}},J=t=>Object.values(t).flat().map(o=>o.name),W=()=>{navigator.geolocation.getCurrentPosition(t=>{const o=m=>Number(m.toFixed(5)),{latitude:a,longitude:h}=t.coords,f={latitude:o(a),longitude:o(h)};sessionStorage.setItem("makanmana_user_loc",JSON.stringify(f)),_(!0),C(!1),T&&(U(T),$(null))},t=>{console.error("Location access denied or error:",t),alert("Unable to get your location. Please enable location access."),$(null)})};l.useEffect(()=>{(async()=>{try{const a=await(await fetch("https://api.naimroslan.dev/restaurants")).json();if(a.data&&Array.isArray(a.data))g(a.data),F(a.data);else{const h=J(a);j(a),g(h),F(h),s(B(a))}}catch(o){console.error("Failed to load restaurants:",o)}})()},[]),l.useEffect(()=>{r.current&&S.set(r.current,{y:0})},[d.length]);const K=l.useCallback(()=>{if(p||!r.current||d.length===0)return;n(!0),c(null);const t=ie,o=t*d.length;S.set(r.current,{y:0}),S.to(r.current,{y:-o*2,duration:oe,ease:"power2.inOut",onComplete:()=>{const a=Math.floor(Math.random()*d.length);c(d[a]),n(!1),S.set(r.current,{y:-a*t})}})},[p,d]),H=()=>{const t=x.trim();t&&u("/chat",{state:{query:t}})},V=t=>{u("/chat",{state:{query:t}})},U=async t=>{if(t.place.some(a=>a.value==="nearby")&&!ae("makanmana_user_loc")){$(t),C(!0);return}I(!0);try{const h=`https://api.naimroslan.dev${ne(t)}`,f=await fetch(h);if(!f.ok)throw new Error(`HTTP error! status: ${f.status}`);const m=await f.json(),N=Object.values(m).flat().filter(Boolean);g(N),c(null),P(!0),r.current&&S.set(r.current,{y:0})}catch(a){console.error("Filter fetch error:",a),alert("Failed to filter restaurants. Please try again.")}finally{I(!1),v(!1)}},X=async()=>{if(y.place.length===0&&y.type.length===0&&y.origin.length===0)try{M(!0);const o=await(await fetch("https://api.naimroslan.dev/filter-options")).json();s({place:[{label:"Nearby",value:"nearby"},{label:"Sunway Putra Mall",value:"sunway-putra-mall"},{label:"TRX Mall",value:"trx-mall"}],type:o.type.map(a=>({label:a,value:a.toLowerCase()})),origin:o.origin.map(a=>({label:a,value:a.toLowerCase()}))})}catch(t){console.error("Failed to load filter options:",t),alert("Failed to load filter options. Please try again.")}finally{M(!1)}v(!0)},Y=()=>{g(R),c(null),P(!1),r.current&&S.set(r.current,{y:0})};return e.jsxs("div",{className:"min-h-screen bg-light flex flex-col",children:[e.jsx("main",{className:"flex-1 px-4 pt-6 pb-24 overflow-auto",children:e.jsxs("div",{className:"w-full max-w-md mx-auto space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-primary text-xl font-semibold mb-2",children:"Ask Me Anything"}),e.jsxs("div",{className:"flex items-center bg-primary-light rounded-full p-2",children:[e.jsx("input",{type:"text",value:x,onChange:t=>b(t.target.value),onKeyPress:t=>t.key==="Enter"&&H(),className:"flex-1 bg-transparent focus:outline-none text-primary px-2 font-funnel font-semibold",placeholder:"What you feel like eating?"}),e.jsx("button",{onClick:H,disabled:!x.trim(),className:"bg-light px-5 py-3 rounded-full text-primary text-xl font-bold disabled:opacity-50",children:e.jsx(Z,{})})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("h2",{className:"text-primary text-xl font-semibold",children:"Today's Pick"}),k&&e.jsxs("span",{className:"text-sm font-normal text-gray",children:["(",d.length," filtered)"]}),!G&&e.jsx("button",{onClick:()=>C(!0),className:"p-1 transition-colors text-gray hover:text-primary",children:e.jsx(ee,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[k&&e.jsx("button",{onClick:Y,className:"text-sm text-primary underline hover:text-primary/80",children:"Reset"}),e.jsx("button",{onClick:X,className:`p-1 transition-colors ${k?"text-primary":"text-gray"}`,children:e.jsx(te,{className:"w-6 h-6"})})]})]}),e.jsxs("div",{className:"bg-white rounded-2xl overflow-hidden border border-border",children:[e.jsxs("div",{className:"relative h-[180px] overflow-hidden",children:[e.jsx("div",{className:"absolute inset-x-0 top-0 h-[60px] bg-gradient-to-b from-white to-transparent z-10 pointer-events-none"}),e.jsx("div",{className:"absolute inset-x-0 bottom-0 h-[60px] bg-gradient-to-t from-white to-transparent z-10 pointer-events-none"}),e.jsxs("div",{ref:r,className:"absolute top-[60px] inset-x-0 transition-all",children:[d.map((t,o)=>{const a=t===i;return e.jsx("div",{onClick:()=>V(t),className:`h-[60px] flex items-center justify-center text-xl font-semibold transition-opacity cursor-pointer ${a?"text-primary opacity-100":"text-gray opacity-30"}`,children:t},t+o)}),d.length===0&&e.jsx("div",{className:"h-[60px] flex items-center justify-center text-gray text-lg",children:k?"No restaurants match your filters":"Loading restaurants..."})]})]}),i&&!p&&e.jsx("div",{className:"p-4 bg-light text-center",children:e.jsxs("p",{className:"text-gray",children:["Makan"," ",e.jsx("span",{className:"font-bold text-primary",children:i})," ","jom!"]})})]}),e.jsx("button",{onClick:K,disabled:p||d.length===0,className:`w-full py-4 px-6 rounded-xl text-white font-semibold text-xl transition-all ${p||d.length===0?"bg-muted cursor-not-allowed":"bg-primary active:scale-95 hover:bg-primary/90"}`,children:p?"Rolling...":d.length===0?k?"No restaurants available":"Loading...":"Makan mana?"})]})}),e.jsx(se,{className:"fixed bottom-0 left-0 right-0 z-50"}),e.jsx(re,{isOpen:A,onClose:()=>v(!1),onApply:U,filterOptions:y,isLoading:D}),q&&e.jsx(le,{onAllow:()=>C(!1),onClose:()=>C(!1),onRequestLocation:W})]})}export{he as default};
